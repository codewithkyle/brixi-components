import{hookup as e,message as t}from"./broadcaster.mjs";import{debug as i,env as r,uuid as a}from"./env.mjs";import{sendPageView as o,setupGoogleAnalytics as s}from"./gtags.mjs";import{transitionManager as n}from"./transition-manager.mjs";import{djinnjsOutDir as c,gaId as l,useServiceWorker as h,followRedirects as p,doPrefetching as u}from"./config.mjs";import{notify as d}from"./notifications.mjs";import{fetchCSS as g}from"./fetch.mjs";new class{constructor(){this.windowPopstateEvent=this.hijackPopstate.bind(this),this.handleLinkClick=this.hijackRequest.bind(this),this.handleIntersection=this.prefetchLink.bind(this),this.state={activeRequestUid:null},this.worker=null,this.serviceWorker=null,this.navigationRequestQueue=[],this.io=new IntersectionObserver(this.handleIntersection),this.init()}init(){sessionStorage.getItem("prompts")||sessionStorage.setItem("prompts","0"),localStorage.getItem("contentCache")||localStorage.setItem("contentCache",""+Date.now()),e("pjax",this.inbox.bind(this)),s(l),this.worker=new Worker(`${window.location.origin}/${c}/pjax-worker.mjs`),this.worker.onmessage=this.handleWorkerMessage.bind(this),"serviceWorker"in navigator&&h&&navigator.serviceWorker.register(window.location.origin+"/service-worker.js",{scope:"/"}).then(()=>{navigator.serviceWorker.controller&&(this.serviceWorker=navigator.serviceWorker.controller,navigator.serviceWorker.onmessage=this.handleServiceWorkerMessage.bind(this),this.serviceWorker.postMessage({type:"cachebust",url:window.location.href}),t({recipient:"pjax",type:"revision-check"}))}).catch(e=>{}),window.addEventListener("popstate",this.windowPopstateEvent),window.history.replaceState({url:window.location.href},document.title,window.location.href),g("pjax-notification")}inbox(e){const{type:i}=e;switch(i){case"revision-check":this.checkPageRevision();break;case"hijack-links":this.collectLinks();break;case"load":this.navigate(e.url,null==e?void 0:e.transition,null==e?void 0:e.transitionData,null==e?void 0:e.history,null==e?void 0:e.selector,null==e?void 0:e.navRequestId);break;case"finalize-pjax":this.updateHistory(e.title,e.url,e.history),new RegExp("#").test(e.url)&&this.scrollToHash(e.url),this.collectLinks(),this.checkPageRevision(),o(window.location.pathname,l),u&&this.prefetchLinks(),t({recipient:"pjax",type:"completed"});break;case"css-ready":this.swapPjaxContent(e.requestUid);break;case"prefetch":u&&this.prefetchLinks();break;case"init":t({recipient:"pjax",type:"hijack-links"}),t({recipient:"pjax",type:"prefetch"});break;default:return}}handleServiceWorkerMessage(e){const{type:t}=e.data;switch(t){case"page-refresh":let t=parseInt(sessionStorage.getItem("prompts"));t+=1,sessionStorage.setItem("prompts",""+t),d({message:"A new version of this page is available.",closeable:!0,force:!0,duration:Infinity,buttons:[{label:"Reload",callback:()=>{window.location.reload()}}]});break;case"cachebust":sessionStorage.setItem("maxPrompts",""+e.data.max);const i=sessionStorage.getItem("prompts");parseInt(i)>=e.data.max&&(sessionStorage.setItem("prompts","0"),this.serviceWorker.postMessage({type:"clear-content-cache"}));const r=parseInt(localStorage.getItem("contentCache"));Date.now()-r>=24*e.data.contentCacheExpires*60*60*1e3&&(localStorage.setItem("contentCache",""+Date.now()),this.serviceWorker.postMessage({type:"clear-content-cache"}))}}handleWorkerMessage(e){var t,i;const{type:a}=e.data;switch(a){case"revision-check":"stale"===e.data.status&&this.serviceWorker.postMessage({type:"page-refresh",url:e.data.url,network:r.connection});break;case"pjax":this.handlePjaxResponse(e.data.requestId,e.data.status,e.data.url,null===(t=e.data)||void 0===t?void 0:t.body,null===(i=e.data)||void 0===i?void 0:i.error)}}scrollToHash(e){const t=e.match(/\#.*/)[0],i=document.body.querySelector(t);i&&i.scrollIntoView()}navigate(e,t=null,i=null,o="push",s=null,n=null){r.startPageTransition();const c=n||a();this.state.activeRequestUid=c;const l={url:e,history:o,requestUid:c,transition:t,transitionData:i,target:document.body.querySelector(`[navigation-request-id="${c}"]`)||null,targetSelector:s};this.navigationRequestQueue.push(l),this.worker.postMessage({type:"pjax",requestId:c,url:e,currentUrl:location.href,followRedirects:p})}hijackPopstate(e){var i;(null===(i=e.state)||void 0===i?void 0:i.url)&&t({recipient:"pjax",type:"load",data:{url:e.state.url,history:"replace"}})}updateHistory(e,t,i){"replace"===i?window.history.replaceState({url:t},e,t):window.history.pushState({url:t},e,t)}hijackRequest(e){e.preventDefault();const i=e.currentTarget,r=a();i.setAttribute("navigation-request-id",r),t({recipient:"pjax",type:"load",data:{url:i.href,transition:i.getAttribute("pjax-transition"),transitionData:i.getAttribute("pjax-transition-data"),selector:i.getAttribute("pjax-view-id"),navRequestId:r}})}collectLinks(){const e=Array.from(document.body.querySelectorAll("a[href]:not([pjax-tracked]):not([no-pjax]):not([target]):not(.no-pjax)"));e.length&&e.map(e=>{e.setAttribute("pjax-tracked","true"),e.addEventListener("click",this.handleLinkClick)})}handlePjaxResponse(e,i,r,a,o){const s=this.getNavigaitonRequest(e);if(e===this.state.activeRequestUid)if("external"===i)window.location.href=r;else if("hash-change"===i)location.hash=r.match(/\#.*/g)[0].replace("#","");else if("ok"===i){const i=document.implementation.createHTMLDocument("pjax-temp-document");let o,n;if(i.documentElement.innerHTML=a,null!==s.targetSelector)o=`[pjax-id="${s.targetSelector}"]`,n=document.body.querySelector(o);else{o="main",n=document.body.querySelector(o);const e=n.getAttribute("pjax-id");e&&(o=`[pjax-id="${e}"]`)}const c=i.querySelector(o);c&&n?(t({recipient:"runtime",type:"parse",data:{body:c.innerHTML,requestUid:e}}),s.body=c.innerHTML,s.title=i.title):window.location.href=r}else window.location.href=r;else this.removeNavigationRequest(s.requestUid)}swapPjaxContent(e){const i=this.getNavigaitonRequest(e);if(i.requestUid===this.state.activeRequestUid){let e;r.endPageTransition(),e=null!==i.targetSelector?`[pjax-id="${i.targetSelector}"]`:"main",n(e,i.body,i.transition,i.target).then(()=>{document.title=i.title,t({recipient:"pjax",type:"finalize-pjax",data:{url:i.url,title:i.title,history:i.history}}),t({recipient:"runtime",type:"mount-components"}),t({recipient:"runtime",type:"mount-inline-scripts",data:{selector:e}})})}this.removeNavigationRequest(i.requestUid)}removeNavigationRequest(e){for(let t=0;t<this.navigationRequestQueue.length;t++)if(this.navigationRequestQueue[t].requestUid===e){this.navigationRequestQueue.splice(t,1);break}}getNavigaitonRequest(e){for(let t=0;t<this.navigationRequestQueue.length;t++)if(this.navigationRequestQueue[t].requestUid===e)return this.navigationRequestQueue[t];return null}checkPageRevision(){this.worker.postMessage({type:"revision-check",url:window.location.href})}prefetchLinks(){if("2g"===r.connection||"slow-2g"===r.connection||!("serviceWorker"in navigator)||r.dataSaver)return;const e=[];Array.from(document.body.querySelectorAll("header a[href]:not([target]):not([pjax-prefetched]):not(prevent-pjax):not(no-transition)")).map(t=>{t.setAttribute("pjax-prefetched","true"),e.push(t.href)});if(Array.from(document.body.querySelectorAll("nav a[href]:not([target]):not([pjax-prefetched]):not(prevent-pjax):not(no-transition)")).map(t=>{t.setAttribute("pjax-prefetched","true"),e.push(t.href)}),this.worker.postMessage({type:"prefetch",urls:e}),"3g"===r.connection)return;Array.from(document.body.querySelectorAll("a[href]:not([target]):not([pjax-prefetched]):not(prevent-pjax):not(no-transition)")).map(e=>{e.setAttribute("pjax-prefetched","true"),this.io.observe(e)})}prefetchLink(e){const t=[];e.map(e=>{if(e.isIntersecting){const i=e.target;this.io.unobserve(i),t.push(i.href)}}),t.length&&this.worker.postMessage({type:"prefetch",urls:t})}};